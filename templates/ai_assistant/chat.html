{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load ai_filters %}

{% block title %}{% trans "المساعد الذكي" %} - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: 65vh;
        overflow-y: auto;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 50%, #e9ecef 100%);
        border-radius: 20px;
        padding: 25px;
        margin-bottom: 20px;
        border: 1px solid rgba(37, 211, 102, 0.1);
        box-shadow:
            0 10px 30px rgba(0,0,0,0.1),
            inset 0 1px 0 rgba(255,255,255,0.8);
        position: relative;
        backdrop-filter: blur(10px);
    }

    .chat-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background:
            radial-gradient(circle at 20% 20%, rgba(37, 211, 102, 0.05) 0%, transparent 50%),
            radial-gradient(circle at 80% 80%, rgba(0, 123, 255, 0.05) 0%, transparent 50%);
        border-radius: 20px;
        pointer-events: none;
    }
    
    .message {
        margin-bottom: 20px;
        display: flex;
        align-items: flex-start;
        animation: fadeInUp 0.3s ease;
    }
    
    .message.user {
        justify-content: flex-end;
    }
    
    .message-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
        margin: 0 15px;
        position: relative;
        overflow: hidden;
        border: 3px solid rgba(255,255,255,0.3);
        transition: all 0.3s ease;
    }

    .message-avatar::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255,255,255,0.4), transparent);
        animation: shine 4s ease-in-out infinite;
    }

    .message.user .message-avatar {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        order: 2;
        box-shadow:
            0 8px 25px rgba(37, 211, 102, 0.4),
            0 4px 10px rgba(37, 211, 102, 0.3);
    }

    .message.user .message-avatar:hover {
        transform: scale(1.1);
        box-shadow:
            0 12px 35px rgba(37, 211, 102, 0.5),
            0 6px 15px rgba(37, 211, 102, 0.4);
    }

    .message.assistant .message-avatar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow:
            0 8px 25px rgba(102, 126, 234, 0.4),
            0 4px 10px rgba(102, 126, 234, 0.3);
        animation: pulse-glow 3s ease-in-out infinite;
    }

    @keyframes pulse-glow {
        0%, 100% {
            box-shadow:
                0 8px 25px rgba(102, 126, 234, 0.4),
                0 4px 10px rgba(102, 126, 234, 0.3);
            transform: scale(1);
        }
        50% {
            box-shadow:
                0 12px 35px rgba(102, 126, 234, 0.6),
                0 6px 15px rgba(102, 126, 234, 0.4);
            transform: scale(1.05);
        }
    }

    @keyframes shine {
        0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
        50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
    }
    
    .message-bubble {
        max-width: 75%;
        padding: 20px 25px;
        border-radius: 25px;
        word-wrap: break-word;
        position: relative;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        transition: all 0.3s ease;
    }

    .message-bubble:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .message.user .message-bubble {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        border-bottom-right-radius: 8px;
        box-shadow:
            0 8px 25px rgba(37, 211, 102, 0.3),
            0 4px 10px rgba(37, 211, 102, 0.2);
        border: 1px solid rgba(255,255,255,0.3);
    }

    .message.user .message-bubble::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255,255,255,0.2), transparent);
        border-radius: 25px;
        border-bottom-right-radius: 8px;
        pointer-events: none;
    }

    .message.assistant .message-bubble {
        background: rgba(255,255,255,0.95);
        color: var(--text-primary);
        border-bottom-left-radius: 8px;
        border: 1px solid rgba(102, 126, 234, 0.2);
        box-shadow:
            0 8px 25px rgba(102, 126, 234, 0.15),
            0 4px 10px rgba(102, 126, 234, 0.1);
    }

    .message.assistant .message-bubble::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), transparent);
        border-radius: 25px;
        border-bottom-left-radius: 8px;
        pointer-events: none;
    }
    
    .message-time {
        font-size: 11px;
        opacity: 0.7;
        margin-top: 5px;
    }
    
    .typing-indicator {
        display: none;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .typing-dots {
        display: flex;
        align-items: center;
        padding: 15px 20px;
        background: white;
        border-radius: 20px;
        border-bottom-left-radius: 5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .typing-dots span {
        height: 8px;
        width: 8px;
        background: #999;
        border-radius: 50%;
        display: inline-block;
        margin: 0 2px;
        animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typing {
        0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .chat-input-container {
        background: rgba(255,255,255,0.95);
        border-radius: 25px;
        padding: 20px;
        box-shadow:
            0 -8px 30px rgba(0,0,0,0.15),
            0 4px 20px rgba(37, 211, 102, 0.1);
        border: 2px solid rgba(37, 211, 102, 0.2);
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
    }

    .chat-input-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(37, 211, 102, 0.05), rgba(0, 123, 255, 0.05));
        pointer-events: none;
    }

    .chat-input {
        border: none;
        outline: none;
        resize: none;
        font-size: 16px;
        line-height: 1.6;
        background: rgba(248, 249, 250, 0.8);
        border-radius: 15px;
        padding: 15px 20px;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        position: relative;
        z-index: 2;
    }

    .chat-input:focus {
        box-shadow: 0 0 0 4px rgba(37, 211, 102, 0.1);
        border-color: var(--primary-color);
        background: white;
    }

    .send-btn {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        color: white;
        font-size: 1.2rem;
        transition: all 0.3s ease;
        box-shadow:
            0 6px 20px rgba(37, 211, 102, 0.4),
            0 3px 10px rgba(37, 211, 102, 0.3);
        position: relative;
        z-index: 2;
        overflow: hidden;
    }

    .send-btn::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
        animation: shine 3s ease-in-out infinite;
    }

    .send-btn:hover {
        transform: scale(1.1) rotate(5deg);
        box-shadow:
            0 8px 25px rgba(37, 211, 102, 0.5),
            0 4px 15px rgba(37, 211, 102, 0.4);
    }

    .send-btn:active {
        transform: scale(0.95);
    }

    .send-btn:disabled {
        opacity: 0.6;
        transform: none;
        cursor: not-allowed;
    }
    
    .conversation-sidebar {
        max-height: 60vh;
        overflow-y: auto;
    }
    
    .conversation-item {
        padding: 15px;
        border-radius: 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid transparent;
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(10px);
    }

    .conversation-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(37, 211, 102, 0.1), transparent);
        transition: left 0.5s ease;
    }

    .conversation-item:hover {
        background: linear-gradient(135deg, rgba(37, 211, 102, 0.1), rgba(0, 123, 255, 0.1));
        border-color: var(--primary-color);
        transform: translateX(5px);
        box-shadow: 0 4px 15px rgba(37, 211, 102, 0.2);
    }

    .conversation-item:hover::before {
        left: 100%;
    }

    .conversation-item.active {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
        transform: translateX(8px);
    }

    .conversation-item.active::before {
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    }

    .usage-stats {
        background: linear-gradient(135deg, rgba(37, 211, 102, 0.1), rgba(0, 123, 255, 0.1));
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 25px;
        border: 1px solid rgba(37, 211, 102, 0.2);
        box-shadow: 0 4px 15px rgba(37, 211, 102, 0.1);
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
    }

    .usage-stats::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(circle at 30% 30%, rgba(37, 211, 102, 0.1) 0%, transparent 50%);
        pointer-events: none;
    }
    
    .image-preview {
        max-width: 200px;
        max-height: 200px;
        border-radius: 10px;
        margin-top: 10px;
    }

    /* تصميم خاص بالجوال للذكاء الاصطناعي */
    @media (max-width: 768px) {
        /* إخفاء الشريط الجانبي في الجوال */
        .mobile-hide-sidebar {
            display: none !important;
        }

        /* تصميم الرأس للجوال */
        .mobile-ai-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px 15px;
            margin: -15px -15px 20px -15px;
            border-radius: 0 0 25px 25px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .mobile-ai-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }

        .mobile-ai-header-content {
            position: relative;
            z-index: 1;
        }

        .mobile-ai-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .mobile-ai-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            margin: 0;
        }

        .mobile-ai-stats {
            background: rgba(255,255,255,0.15);
            border-radius: 20px;
            padding: 10px 15px;
            margin-top: 15px;
            backdrop-filter: blur(10px);
        }

        .mobile-ai-stats-text {
            font-size: 0.8rem;
            margin: 0;
        }

        /* تحسين حاوية الدردشة للجوال */
        .mobile-chat-container {
            height: calc(100vh - 220px);
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 20px 20px 0 0;
            padding: 15px;
            margin: 0 -15px;
            overflow-y: auto;
            position: relative;
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* تحسين الرسائل للجوال */
        .mobile-message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            animation: slideInUp 0.4s ease;
        }

        .mobile-message.user {
            justify-content: flex-end;
        }

        .mobile-message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin: 0 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .mobile-message.user .mobile-message-avatar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            order: 2;
        }

        .mobile-message.assistant .mobile-message-avatar {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .mobile-message-bubble {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .mobile-message.user .mobile-message-bubble {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-bottom-right-radius: 6px;
        }

        .mobile-message.assistant .mobile-message-bubble {
            background: rgba(255,255,255,0.95);
            color: var(--text-primary);
            border-bottom-left-radius: 6px;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .mobile-message-time {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 4px;
        }

        /* تحسين منطقة الإدخال للجوال */
        .mobile-chat-input-container {
            background: white;
            border-radius: 25px 25px 0 0;
            padding: 20px 15px;
            margin: 0 -15px -15px -15px;
            box-shadow: 0 -8px 30px rgba(0,0,0,0.15);
            border-top: 2px solid var(--primary-color);
            position: sticky;
            bottom: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .mobile-input-wrapper {
            background: #f8f9fa;
            border-radius: 25px;
            padding: 8px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            position: relative;
        }

        .mobile-input-wrapper:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(37, 211, 102, 0.1);
            background: white;
        }

        .mobile-chat-input {
            border: none;
            outline: none;
            resize: none;
            font-size: 16px;
            line-height: 1.5;
            background: transparent;
            padding: 8px 16px;
            width: 100%;
            min-height: 20px;
            max-height: 120px;
        }

        .mobile-chat-input::placeholder {
            color: #6c757d;
            font-style: italic;
        }

        .mobile-input-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .mobile-image-btn {
            background: linear-gradient(135deg, #6c757d, #495057);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .mobile-image-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .mobile-send-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            color: white;
            font-size: 18px;
            transition: all 0.3s ease;
            box-shadow: 0 3px 12px rgba(37, 211, 102, 0.4);
            margin-right: auto;
        }

        .mobile-send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 20px rgba(37, 211, 102, 0.5);
        }

        .mobile-send-btn:disabled {
            opacity: 0.6;
            transform: none;
            cursor: not-allowed;
        }

        .mobile-send-btn:active {
            transform: scale(0.95);
        }

        /* معاينة الصورة للجوال */
        .mobile-image-preview {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid var(--primary-color);
            position: relative;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            animation: slideInUp 0.3s ease;
        }

        .mobile-image-preview img {
            max-width: 120px;
            max-height: 120px;
            border-radius: 12px;
            object-fit: cover;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border: 2px solid white;
        }

        .mobile-remove-image {
            position: absolute;
            top: 8px;
            right: 8px;
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
        }

        .mobile-remove-image:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.5);
        }

        /* مؤشر التحميل للجوال */
        .mobile-loading-indicator {
            display: none;
            align-items: center;
            justify-content: center;
            padding: 10px;
            background: rgba(37, 211, 102, 0.1);
            border-radius: 20px;
            margin-bottom: 10px;
        }

        .mobile-loading-indicator.show {
            display: flex;
        }

        .mobile-loading-text {
            color: var(--primary-color);
            font-size: 14px;
            font-weight: 500;
            margin-right: 8px;
        }

        .mobile-loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--primary-color);
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* تحسين الرسائل في الجوال */
        .mobile-message-bubble .image-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 12px;
            margin-top: 8px;
            border: 2px solid rgba(255,255,255,0.3);
        }

        /* زر سجل المحادثات للجوال */
        .mobile-conversations-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 50%;
            width: 55px;
            height: 55px;
            font-size: 20px;
            box-shadow: 0 4px 20px rgba(37, 211, 102, 0.4);
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mobile-conversations-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
        }

        .mobile-conversations-btn:active {
            transform: scale(0.95);
        }

        /* قائمة المحادثات المنبثقة للجوال */
        .mobile-conversations-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1500;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .mobile-conversations-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .mobile-conversations-sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100vh;
            background: white;
            z-index: 1600;
            transition: all 0.3s ease;
            box-shadow: 4px 0 20px rgba(0,0,0,0.2);
            overflow-y: auto;
        }

        .mobile-conversations-sidebar.show {
            left: 0;
        }

        .mobile-conversations-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px 15px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .mobile-conversations-header-content {
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .mobile-conversations-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
            flex: 1;
        }

        .mobile-conversations-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .mobile-conversations-close:hover {
            background: rgba(255,255,255,0.2);
        }

        .mobile-conversations-content {
            padding: 15px;
        }

        .mobile-new-conversation-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 20px;
            width: 100%;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .mobile-new-conversation-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
        }

        .mobile-conversation-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .mobile-conversation-item:hover {
            background: #e9ecef;
            border-color: var(--primary-color);
            transform: translateX(5px);
        }

        .mobile-conversation-item.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .mobile-conversation-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            line-height: 1.3;
        }

        .mobile-conversation-time {
            font-size: 12px;
            opacity: 0.7;
        }

        .mobile-conversations-empty {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .mobile-conversations-empty i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .mobile-usage-stats {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }

        .mobile-usage-title {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .mobile-usage-progress {
            background: #e9ecef;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .mobile-usage-bar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .mobile-usage-text {
            font-size: 11px;
            color: #6c757d;
            text-align: center;
        }

        /* أزرار الإجراءات السريعة للجوال */
        .mobile-quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .mobile-quick-btn {
            background: rgba(255,255,255,0.9);
            border: 1px solid rgba(37, 211, 102, 0.2);
            border-radius: 15px;
            padding: 15px 10px;
            text-align: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .mobile-quick-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
        }

        .mobile-quick-btn i {
            font-size: 1.2rem;
            margin-bottom: 5px;
            display: block;
        }

        .mobile-quick-btn span {
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* رسالة الترحيب للجوال */
        .mobile-welcome {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .mobile-welcome-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .mobile-welcome-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .mobile-welcome-text {
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 25px;
        }

        /* مؤشر الكتابة للجوال */
        .mobile-typing-indicator {
            display: none;
            align-items: center;
            margin-bottom: 15px;
        }

        .mobile-typing-dots {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255,255,255,0.95);
            border-radius: 18px;
            border-bottom-left-radius: 6px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }

        .mobile-typing-dots span {
            height: 6px;
            width: 6px;
            background: #999;
            border-radius: 50%;
            display: inline-block;
            margin: 0 1px;
            animation: mobileTyping 1.4s infinite ease-in-out;
        }

        .mobile-typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .mobile-typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        /* الحركات والتأثيرات */
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes mobileTyping {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* إخفاء عناصر سطح المكتب في الجوال */
        .desktop-only {
            display: none !important;
        }

        /* تنسيق Markdown للرسائل */
        .message-content h1, .message-content h2, .message-content h3,
        .message-content h4, .message-content h5, .message-content h6 {
            margin: 15px 0 10px 0;
            font-weight: 700;
            color: #2c3e50;
        }

        .message-content h1 { font-size: 1.8rem; color: #e74c3c; }
        .message-content h2 { font-size: 1.6rem; color: #3498db; }
        .message-content h3 { font-size: 1.4rem; color: #f39c12; }
        .message-content h4 { font-size: 1.2rem; color: #27ae60; }
        .message-content h5 { font-size: 1.1rem; color: #9b59b6; }
        .message-content h6 { font-size: 1rem; color: #34495e; }

        .message-content strong, .message-content b {
            font-weight: 700;
            color: #2c3e50;
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
            padding: 2px 6px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .message-content em, .message-content i {
            font-style: italic;
            color: #7f8c8d;
            background: #ecf0f1;
            padding: 1px 4px;
            border-radius: 3px;
        }

        .message-content code {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 3px 8px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .message-content pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 10px;
            overflow-x: auto;
            margin: 10px 0;
            border-left: 4px solid #3498db;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .message-content pre code {
            background: none;
            padding: 0;
            box-shadow: none;
        }

        .message-content ul, .message-content ol {
            margin: 10px 0;
            padding-right: 20px;
        }

        .message-content li {
            margin: 8px 0;
            padding: 5px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .message-content li:last-child {
            border-bottom: none;
        }

        .message-content blockquote {
            border-right: 4px solid #3498db;
            background: #f8f9fa;
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 8px;
            font-style: italic;
            color: #555;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* زر النسخ */
        .copy-button {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(52, 152, 219, 0.9);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 0.8rem;
            cursor: pointer;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .message.assistant:hover .copy-button {
            opacity: 1;
        }

        .copy-button:hover {
            background: rgba(41, 128, 185, 1);
            transform: scale(1.05);
        }

        .copy-button.copied {
            background: rgba(39, 174, 96, 0.9);
        }

        .copy-button.copied::after {
            content: " ✓";
        }

        /* تحسين أيقونات الرسائل */
        .message-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 4px 12px rgba(0,0,0,0.15), 0 0 0 0 rgba(245, 87, 108, 0.7);
            }
            50% {
                box-shadow: 0 4px 12px rgba(0,0,0,0.15), 0 0 0 10px rgba(245, 87, 108, 0);
            }
        }

        .message.system .message-avatar {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #d63031;
        }

        /* تحسين أيقونات الجوال */
        .mobile-message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
        }

        .mobile-message.user .mobile-message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .mobile-message.assistant .mobile-message-avatar {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            animation: pulse-glow 2s ease-in-out infinite;
        }

        /* تحسين أيقونة الرأس للجوال */
        .mobile-ai-title i {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2rem;
            margin-left: 10px;
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        /* تنسيق النصوص المحسن */
        .formatted-content {
            line-height: 1.7;
        }

        .formatted-content h1,
        .formatted-content h2,
        .formatted-content h3,
        .formatted-content h4,
        .formatted-content h5,
        .formatted-content h6 {
            color: var(--primary-color);
            margin: 15px 0 10px 0;
            font-weight: 700;
        }

        .formatted-content h1 { font-size: 1.8rem; }
        .formatted-content h2 { font-size: 1.6rem; }
        .formatted-content h3 { font-size: 1.4rem; }
        .formatted-content h4 { font-size: 1.2rem; }

        .formatted-content strong,
        .formatted-content b {
            color: var(--primary-color);
            font-weight: 700;
        }

        .formatted-content em,
        .formatted-content i {
            color: var(--secondary-color);
            font-style: italic;
        }

        .formatted-content ul,
        .formatted-content ol {
            margin: 10px 0;
            padding-right: 20px;
        }

        .formatted-content li {
            margin: 5px 0;
            line-height: 1.6;
        }

        .formatted-content blockquote {
            border-right: 4px solid var(--primary-color);
            background: rgba(37, 211, 102, 0.1);
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 8px;
            font-style: italic;
        }

        .formatted-content code {
            background: #f8f9fa;
            color: #e83e8c;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .formatted-content pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            overflow-x: auto;
            direction: ltr;
            text-align: left;
        }

        .formatted-content pre code {
            background: none;
            padding: 0;
            color: #495057;
        }

        /* أيقونات المساعد الذكي المحسنة للكمبيوتر */
        .ai-message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-radius: 15px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .ai-message-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 3s ease-in-out infinite;
        }

        .ai-icons {
            display: flex;
            gap: 12px;
            position: relative;
            z-index: 2;
        }

        .ai-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .ai-icon::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: iconShine 4s ease-in-out infinite;
        }

        .ai-icon:hover {
            transform: scale(1.2) rotate(10deg);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .ai-icon:nth-child(1) {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            animation: float 3s ease-in-out infinite;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        .ai-icon:nth-child(1):hover {
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.6);
        }

        .ai-icon:nth-child(2) {
            background: linear-gradient(135deg, #4834d4, #686de0);
            animation: float 3s ease-in-out infinite;
            animation-delay: 1s;
            box-shadow: 0 6px 20px rgba(72, 52, 212, 0.4);
        }

        .ai-icon:nth-child(2):hover {
            box-shadow: 0 10px 30px rgba(72, 52, 212, 0.6);
        }

        .ai-icon:nth-child(3) {
            background: linear-gradient(135deg, #00d2d3, #54a0ff);
            animation: float 3s ease-in-out infinite;
            animation-delay: 2s;
            box-shadow: 0 6px 20px rgba(0, 210, 211, 0.4);
        }

        .ai-icon:nth-child(3):hover {
            box-shadow: 0 10px 30px rgba(0, 210, 211, 0.6);
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px) scale(1);
            }
            50% {
                transform: translateY(-8px) scale(1.05);
            }
        }

        @keyframes shimmer {
            0% { left: -100%; }
            50% { left: 100%; }
            100% { left: -100%; }
        }

        @keyframes iconShine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
            100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
        }

        /* تأثيرات إضافية للأيقونات */
        .ai-icon:nth-child(1)::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 6px;
            height: 6px;
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: pulse 2s ease-in-out infinite;
        }

        .ai-icon:nth-child(2)::after {
            content: '';
            position: absolute;
            top: 20%;
            right: 20%;
            width: 4px;
            height: 4px;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            animation: twinkle 1.5s ease-in-out infinite;
        }

        .ai-icon:nth-child(3)::after {
            content: '';
            position: absolute;
            bottom: 20%;
            left: 20%;
            width: 5px;
            height: 5px;
            background: rgba(255,255,255,0.7);
            border-radius: 50%;
            animation: glow 2.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: translate(-50%, -50%) scale(0.8); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1); }
        }

        @keyframes glow {
            0%, 100% { opacity: 0.5; box-shadow: 0 0 5px rgba(255,255,255,0.5); }
            50% { opacity: 1; box-shadow: 0 0 15px rgba(255,255,255,0.8); }
        }

        /* تأثيرات الظهور للأيقونات */
        .ai-icon {
            animation: float 3s ease-in-out infinite, iconAppear 0.6s ease-out;
        }

        .ai-icon:nth-child(1) {
            animation-delay: 0s, 0.1s;
        }

        .ai-icon:nth-child(2) {
            animation-delay: 1s, 0.3s;
        }

        .ai-icon:nth-child(3) {
            animation-delay: 2s, 0.5s;
        }

        @keyframes iconAppear {
            0% {
                opacity: 0;
                transform: translateY(20px) scale(0.5) rotate(180deg);
            }
            50% {
                opacity: 0.7;
                transform: translateY(-5px) scale(1.1) rotate(90deg);
            }
            100% {
                opacity: 1;
                transform: translateY(0px) scale(1) rotate(0deg);
            }
        }

        /* تأثير خاص عند النقر على الأيقونات */
        .ai-icon:active {
            animation: iconClick 0.3s ease-out;
        }

        @keyframes iconClick {
            0% { transform: scale(1); }
            50% { transform: scale(0.9) rotate(15deg); }
            100% { transform: scale(1.1) rotate(-5deg); }
        }

        /* تأثير الهالة للأيقونات */
        .ai-icon:hover::before {
            animation: iconShine 1s ease-out;
        }

        /* تحسين الرسوم المتحركة للجوال - إخفاء التأثيرات المعقدة */
        @media (max-width: 768px) {
            .ai-message-header {
                padding: 10px 15px;
                background: rgba(102, 126, 234, 0.1);
            }

            .ai-icon {
                width: 30px;
                height: 30px;
                font-size: 0.9rem;
            }

            .ai-icon::before,
            .ai-icon::after {
                display: none;
            }

            .ai-message-header::before {
                display: none;
            }
        }

        /* زر النسخ المحسن للكمبيوتر */
        .copy-btn {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.8), rgba(118, 75, 162, 0.8));
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 25px;
            padding: 10px 18px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            z-index: 2;
            overflow: hidden;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .copy-btn::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: buttonShine 3s ease-in-out infinite;
        }

        .copy-btn:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 1), rgba(118, 75, 162, 1));
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
            border-color: rgba(255,255,255,0.5);
        }

        .copy-btn:active {
            transform: translateY(-1px) scale(0.98);
        }

        .copy-btn.copied {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-color: rgba(255,255,255,0.4);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .copy-btn.copied::before {
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.4), transparent);
        }

        .copy-btn i {
            font-size: 0.8rem;
            position: relative;
            z-index: 2;
        }

        .copy-btn span {
            position: relative;
            z-index: 2;
            font-weight: 600;
        }

        @keyframes buttonShine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
            100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
        }

        /* حركات إضافية للتصميم المحسن */
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            33% { transform: translateY(-10px) rotate(1deg); }
            66% { transform: translateY(5px) rotate(-1deg); }
        }

        /* تحسينات إضافية للبطاقات */
        .card {
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        /* تحسين الأزرار */
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        /* تحسين الشريط الجانبي */
        .card-body {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
        }
    }
</style>
{% endblock %}

{% block main_content %}
<!-- زر سجل المحادثات للجوال -->
<button class="mobile-conversations-btn d-md-none" id="mobileConversationsBtn" onclick="toggleMobileConversations()">
    <i class="fas fa-ellipsis-v"></i>
</button>

<!-- قائمة المحادثات المنبثقة للجوال -->
<div class="mobile-conversations-overlay d-md-none" id="mobileConversationsOverlay" onclick="closeMobileConversations()"></div>
<div class="mobile-conversations-sidebar d-md-none" id="mobileConversationsSidebar">
    <div class="mobile-conversations-header">
        <div class="mobile-conversations-header-content">
            <h3 class="mobile-conversations-title">{% trans "المحادثات" %}</h3>
            <button class="mobile-conversations-close" onclick="closeMobileConversations()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <div class="mobile-conversations-content">
        <!-- إحصائيات الاستخدام -->
        <div class="mobile-usage-stats">
            <div class="mobile-usage-title">{% trans "الاستخدام اليومي" %}</div>
            <div class="mobile-usage-progress">
                <div class="mobile-usage-bar" style="width: {{ usage_stats.daily_messages_count|default:0|percentage:daily_limit|default:50 }}%"></div>
            </div>
            <div class="mobile-usage-text">{{ usage_stats.daily_messages_count|default:0 }}/{{ daily_limit|default:50 }} {% trans "رسالة" %}</div>
        </div>

        <!-- زر محادثة جديدة -->
        <button class="mobile-new-conversation-btn" onclick="startNewConversation()">
            <i class="fas fa-plus me-2"></i>
            {% trans "محادثة جديدة" %}
        </button>

        <!-- قائمة المحادثات -->
        <div class="mobile-conversations-list">
            {% for conv in recent_conversations %}
                <div class="mobile-conversation-item {% if conversation and conv.id == conversation.id %}active{% endif %}"
                     onclick="loadConversation({{ conv.id }})">
                    <div class="mobile-conversation-title">{{ conv.title|truncatechars:35 }}</div>
                    <div class="mobile-conversation-time">{{ conv.updated_at|timesince }} {% trans "منذ" %}</div>
                </div>
            {% empty %}
                <div class="mobile-conversations-empty">
                    <i class="fas fa-comments"></i>
                    <p>{% trans "لا توجد محادثات سابقة" %}</p>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<div class="container-fluid">
    <!-- رأس الجوال -->
    <div class="mobile-ai-header d-md-none">
        <div class="mobile-ai-header-content">
            <h1 class="mobile-ai-title">
                <i class="fas fa-robot"></i>
                {% trans "الذكاء الاصطناعي" %}
            </h1>
            <p class="mobile-ai-subtitle">{% trans "مساعدك الشخصي الذكي" %}</p>
            <div class="mobile-ai-stats">
                <p class="mobile-ai-stats-text">
                    {% trans "الاستخدام اليومي:" %} {{ usage_stats.daily_messages_count|default:0 }}/{{ daily_limit|default:50 }}
                </p>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Conversations Sidebar -->
        <div class="col-lg-3 mb-4 mobile-hide-sidebar desktop-only">
            <div class="card h-100" style="border: none; box-shadow: 0 15px 40px rgba(0,0,0,0.1); border-radius: 25px; overflow: hidden;">
                <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 20px; position: relative; overflow: hidden;">
                    <!-- خلفية متحركة -->
                    <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); animation: float 8s ease-in-out infinite;"></div>

                    <div style="position: relative; z-index: 2;">
                        <h5 class="mb-0" style="font-weight: 700; display: flex; align-items: center; gap: 10px;">
                            <div style="width: 35px; height: 35px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem;">
                                <i class="fas fa-comments"></i>
                            </div>
                            {% trans "المحادثات" %}
                        </h5>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Usage Stats -->
                    <div class="usage-stats m-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">{% trans "الاستخدام اليومي" %}</small>
                            <span class="badge bg-primary">{{ usage_stats.daily_messages_count|default:0 }}/{{ daily_limit|default:50 }}</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar" style="width: {{ usage_stats.daily_messages_count|default:0|percentage:daily_limit|default:50 }}%"></div>
                        </div>
                    </div>

                    <!-- New Conversation Button -->
                    <div class="p-3">
                        <button class="w-100" onclick="startNewConversation()" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; border: none; border-radius: 15px; padding: 15px 20px; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 6px 20px rgba(37, 211, 102, 0.3); position: relative; overflow: hidden;">
                            <!-- تأثير اللمعان -->
                            <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent); animation: shine 3s ease-in-out infinite;"></div>

                            <div style="position: relative; z-index: 2; display: flex; align-items: center; justify-content: center; gap: 10px;">
                                <i class="fas fa-plus"></i>
                                {% trans "محادثة جديدة" %}
                            </div>
                        </button>
                    </div>

                    <!-- Conversations List -->
                    <div class="conversation-sidebar p-3">
                        {% for conv in recent_conversations %}
                            <div class="conversation-item {% if conversation and conv.id == conversation.id %}active{% endif %}"
                                 onclick="loadConversation({{ conv.id }})">
                                <h6 class="mb-1">{{ conv.title|truncatechars:30 }}</h6>
                                <small class="text-muted">
                                    {{ conv.updated_at|timesince }} {% trans "منذ" %}
                                </small>
                            </div>
                        {% empty %}
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-comments fa-2x mb-2"></i>
                                <p>{% trans "لا توجد محادثات سابقة" %}</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chat Area -->
        <div class="col-lg-9 col-12">
            <div class="card h-100 d-none d-md-block" style="border: none; box-shadow: 0 15px 40px rgba(0,0,0,0.1); border-radius: 25px; overflow: hidden;">
                <div class="card-header" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; border: none; padding: 25px; position: relative; overflow: hidden;">
                    <!-- خلفية متحركة -->
                    <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); animation: float 6s ease-in-out infinite;"></div>

                    <div style="position: relative; z-index: 2;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h4 class="mb-2" style="font-weight: 800; display: flex; align-items: center; gap: 15px;">
                                    <div style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; animation: pulse-glow 3s ease-in-out infinite;">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    {% trans "المساعد الذكي" %}
                                </h4>
                                <p class="mb-0" style="opacity: 0.9; font-size: 1rem;">
                                    {% trans "مساعدك الشخصي لإدارة المهام وحل المشاكل" %}
                                </p>
                            </div>

                            <!-- إحصائيات سريعة -->
                            <div style="text-align: center; background: rgba(255,255,255,0.15); border-radius: 15px; padding: 15px 20px; backdrop-filter: blur(10px);">
                                <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 5px;">{{ usage_stats.daily_messages_count|default:0 }}</div>
                                <div style="font-size: 0.8rem; opacity: 0.9;">{% trans "رسالة اليوم" %}</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card-body d-flex flex-column">
                    <!-- Chat Messages -->
                    <div class="chat-container flex-grow-1" id="chatContainer">
                        {% if conversation %}
                            {% for message in conversation.messages.all %}
                                <div class="message {{ message.message_type }}">
                                    <div class="message-avatar">
                                        {% if message.message_type == 'user' %}
                                            <i class="fas fa-user"></i>
                                        {% else %}
                                            <i class="fas fa-robot"></i>
                                        {% endif %}
                                    </div>
                                    <div class="message-bubble">
                                        {% if message.message_type == 'assistant' %}
                                            <!-- أيقونات المساعد الذكي -->
                                            <div class="ai-message-header">
                                                <div class="ai-icons">
                                                    <div class="ai-icon">
                                                        <i class="fas fa-robot"></i>
                                                    </div>
                                                    <div class="ai-icon">
                                                        <i class="fas fa-brain"></i>
                                                    </div>
                                                    <div class="ai-icon">
                                                        <i class="fas fa-magic"></i>
                                                    </div>
                                                </div>
                                                <button class="copy-btn" onclick="copyToClipboard('{{ message.content|escapejs }}', this)" title="نسخ النص">
                                                    <i class="fas fa-copy"></i>
                                                    <span>نسخ</span>
                                                </button>
                                            </div>
                                        {% endif %}
                                        <div class="message-content">
                                            {% if message.message_type == 'assistant' %}
                                                <div id="message-{{ message.id }}">{{ message.content|linebreaks }}</div>
                                                <script>
                                                    document.getElementById('message-{{ message.id }}').innerHTML = parseMarkdown('{{ message.content|escapejs }}');
                                                </script>
                                            {% else %}
                                                {{ message.content|linebreaks }}
                                            {% endif %}
                                            {% if message.image %}
                                                <img src="{{ message.image.url }}" class="image-preview" alt="Uploaded image">
                                            {% endif %}
                                        </div>
                                        <div class="message-time">
                                            {{ message.created_at|date:"H:i" }}
                                            {% if message.message_type == 'assistant' and message.response_time %}
                                                • {{ message.response_time|floatformat:1 }}s
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <!-- Desktop Welcome -->
                            <div class="text-center py-5 d-none d-md-block">
                                <i class="fas fa-robot fa-4x text-muted mb-3"></i>
                                <h4 class="text-muted">{% trans "مرحباً! كيف يمكنني مساعدتك اليوم؟" %}</h4>
                                <p class="text-muted">
                                    {% trans "يمكنني مساعدتك في إدارة مهامك، حل الواجبات، تحليل الصور، وأكثر!" %}
                                </p>

                                <!-- Quick Actions -->
                                <div class="row mt-4">
                                    <div class="col-lg-3 col-md-6 mb-2">
                                        <button class="btn btn-outline-primary w-100" onclick="sendQuickMessage('نظم مهامي: دراسة الرياضيات، شراء البقالة، ممارسة الرياضة، الاتصال بالطبيب')">
                                            <i class="fas fa-tasks me-2"></i>
                                            {% trans "تنظيم المهام" %}
                                        </button>
                                    </div>
                                    <div class="col-lg-3 col-md-6 mb-2">
                                        <button class="btn btn-outline-success w-100" onclick="sendQuickMessage('ساعدني في حل واجب الرياضيات')">
                                            <i class="fas fa-graduation-cap me-2"></i>
                                            {% trans "حل الواجبات" %}
                                        </button>
                                    </div>
                                    <div class="col-lg-3 col-md-6 mb-2">
                                        <button class="btn btn-outline-info w-100" onclick="sendQuickMessage('اقترح علي نصائح لتحسين الإنتاجية')">
                                            <i class="fas fa-lightbulb me-2"></i>
                                            {% trans "نصائح ذكية" %}
                                        </button>
                                    </div>
                                    <div class="col-lg-3 col-md-6 mb-2">
                                        <button class="btn btn-outline-warning w-100" onclick="document.getElementById('imageInput').click()">
                                            <i class="fas fa-image me-2"></i>
                                            {% trans "رفع صورة" %}
                                        </button>
                                    </div>
                                </div>

                                <!-- Additional Quick Actions -->
                                <div class="row mt-2">
                                    <div class="col-lg-4 col-md-6 mb-2">
                                        <button class="btn btn-outline-secondary btn-sm w-100" onclick="sendQuickMessage('رتب مهامي مع أوقاتها في جدول')">
                                            <i class="fas fa-calendar-alt me-2"></i>
                                            {% trans "جدول زمني" %}
                                        </button>
                                    </div>
                                    <div class="col-lg-4 col-md-6 mb-2">
                                        <button class="btn btn-outline-secondary btn-sm w-100" onclick="sendQuickMessage('حل هذه المسألة: 25 × 16')">
                                            <i class="fas fa-calculator me-2"></i>
                                            {% trans "حساب سريع" %}
                                        </button>
                                    </div>
                                    <div class="col-lg-4 col-md-6 mb-2">
                                        <button class="btn btn-outline-secondary btn-sm w-100" onclick="sendQuickMessage('اقترح علي خطة دراسية للأسبوع')">
                                            <i class="fas fa-book me-2"></i>
                                            {% trans "خطة دراسية" %}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                        
                        <!-- Typing Indicator -->
                        <div class="typing-indicator" id="typingIndicator">
                            <div class="message-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="typing-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Input -->
                    <div class="chat-input-container">
                        <form id="chatForm" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="row align-items-end">
                                <div class="col">
                                    <textarea
                                        class="form-control chat-input"
                                        id="messageInput"
                                        placeholder="{% trans 'اكتب رسالتك هنا...' %}"
                                        rows="1"
                                        maxlength="2000"
                                    ></textarea>
                                </div>
                                <div class="col-auto">
                                    <input type="file" id="imageInput" accept="image/*" style="display: none;">
                                    <button type="button" class="btn btn-outline-secondary me-2" onclick="document.getElementById('imageInput').click()">
                                        <i class="fas fa-image"></i>
                                    </button>
                                    <button type="submit" class="send-btn" id="sendBtn">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Image Preview -->
                            <div id="imagePreview" style="display: none;" class="mt-2">
                                <img id="previewImg" class="image-preview" alt="Preview">
                                <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="removeImage()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Mobile Chat Interface -->
            <div class="d-md-none">
                <!-- Mobile Chat Container -->
                <div class="mobile-chat-container" id="mobileChatContainer">
                    {% if conversation %}
                        {% for message in conversation.messages.all %}
                            <div class="mobile-message {{ message.message_type }}">
                                <div class="mobile-message-avatar">
                                    {% if message.message_type == 'user' %}
                                        <i class="fas fa-user"></i>
                                    {% else %}
                                        <i class="fas fa-robot"></i>
                                    {% endif %}
                                </div>
                                <div class="mobile-message-bubble">
                                    {% if message.message_type == 'assistant' %}
                                        <!-- أيقونات المساعد الذكي للجوال -->
                                        <div class="ai-message-header">
                                            <div class="ai-icons">
                                                <div class="ai-icon">
                                                    <i class="fas fa-robot"></i>
                                                </div>
                                                <div class="ai-icon">
                                                    <i class="fas fa-brain"></i>
                                                </div>
                                                <div class="ai-icon">
                                                    <i class="fas fa-magic"></i>
                                                </div>
                                            </div>
                                            <button class="copy-btn" onclick="copyToClipboard('{{ message.content|escapejs }}', this)" title="نسخ النص">
                                                <i class="fas fa-copy"></i>
                                                <span>نسخ</span>
                                            </button>
                                        </div>
                                    {% endif %}
                                    <div class="message-content">
                                        {% if message.message_type == 'assistant' %}
                                            <div id="mobile-message-{{ message.id }}">{{ message.content|linebreaks }}</div>
                                            <script>
                                                document.getElementById('mobile-message-{{ message.id }}').innerHTML = parseMarkdown('{{ message.content|escapejs }}');
                                            </script>
                                        {% else %}
                                            {{ message.content|linebreaks }}
                                        {% endif %}
                                        {% if message.image %}
                                            <img src="{{ message.image.url }}" class="image-preview" alt="Uploaded image">
                                        {% endif %}
                                    </div>
                                    <div class="mobile-message-time">
                                        {{ message.created_at|date:"H:i" }}
                                        {% if message.message_type == 'assistant' and message.response_time %}
                                            • {{ message.response_time|floatformat:1 }}s
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <!-- Mobile Welcome -->
                        <div class="mobile-welcome">
                            <div class="mobile-welcome-icon">
                                <i class="fas fa-robot"></i>
                            </div>
                            <h4 class="mobile-welcome-title">{% trans "مرحباً بك!" %}</h4>
                            <p class="mobile-welcome-text">
                                {% trans "كيف يمكنني مساعدتك اليوم؟ يمكنني مساعدتك في إدارة مهامك وحل مشاكلك." %}
                            </p>

                            <!-- Mobile Quick Actions -->
                            <div class="mobile-quick-actions">
                                <button class="mobile-quick-btn" onclick="sendQuickMessage('نظم مهامي اليومية')">
                                    <i class="fas fa-tasks"></i>
                                    <span>{% trans "تنظيم المهام" %}</span>
                                </button>
                                <button class="mobile-quick-btn" onclick="sendQuickMessage('ساعدني في حل واجب')">
                                    <i class="fas fa-graduation-cap"></i>
                                    <span>{% trans "حل الواجبات" %}</span>
                                </button>
                                <button class="mobile-quick-btn" onclick="sendQuickMessage('اقترح نصائح للإنتاجية')">
                                    <i class="fas fa-lightbulb"></i>
                                    <span>{% trans "نصائح ذكية" %}</span>
                                </button>
                                <button class="mobile-quick-btn" onclick="document.getElementById('mobileImageInput').click()">
                                    <i class="fas fa-image"></i>
                                    <span>{% trans "رفع صورة" %}</span>
                                </button>
                                <button class="mobile-quick-btn" onclick="sendQuickMessage('رتب جدولي الزمني')">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>{% trans "جدول زمني" %}</span>
                                </button>
                                <button class="mobile-quick-btn" onclick="sendQuickMessage('حل مسألة رياضية')">
                                    <i class="fas fa-calculator"></i>
                                    <span>{% trans "حساب سريع" %}</span>
                                </button>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Mobile Typing Indicator -->
                    <div class="mobile-typing-indicator" id="mobileTypingIndicator">
                        <div class="mobile-message-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="mobile-typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>

                <!-- Mobile Chat Input -->
                <div class="mobile-chat-input-container">
                    <form id="mobileChatForm" enctype="multipart/form-data">
                        {% csrf_token %}

                        <!-- Mobile Loading Indicator -->
                        <div id="mobileLoadingIndicator" class="mobile-loading-indicator">
                            <span class="mobile-loading-text">{% trans "جاري الإرسال..." %}</span>
                            <div class="mobile-loading-spinner"></div>
                        </div>

                        <!-- Mobile Image Preview -->
                        <div id="mobileImagePreview" class="mobile-image-preview">
                            <img id="mobilePreviewImg" alt="معاينة الصورة">
                            <button type="button" class="mobile-remove-image" onclick="removeMobileImage()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <!-- Input Wrapper -->
                        <div class="mobile-input-wrapper">
                            <textarea
                                class="mobile-chat-input"
                                id="mobileMessageInput"
                                placeholder="{% trans 'اكتب رسالتك هنا... 💬' %}"
                                rows="1"
                                maxlength="2000"
                            ></textarea>

                            <!-- Action Buttons -->
                            <div class="mobile-input-actions">
                                <input type="file" id="mobileImageInput" accept="image/*" style="display: none;">
                                <button type="button" class="mobile-image-btn" onclick="document.getElementById('mobileImageInput').click()" title="{% trans 'إرفاق صورة' %}">
                                    <i class="fas fa-image"></i>
                                </button>
                                <button type="submit" class="mobile-send-btn" id="mobileSendBtn" title="{% trans 'إرسال' %}">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- مكتبة Marked.js لمعالجة Markdown -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
let currentConversationId = {% if conversation %}{{ conversation.id }}{% else %}null{% endif %};

// Auto-resize textarea
document.getElementById('messageInput').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
});

// Handle image selection
document.getElementById('imageInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('previewImg').src = e.target.result;
            document.getElementById('imagePreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
});

// Remove image
function removeImage() {
    document.getElementById('imageInput').value = '';
    document.getElementById('imagePreview').style.display = 'none';
}

// Send quick message
function sendQuickMessage(message) {
    // Check if mobile or desktop
    const isMobile = window.innerWidth < 768;

    if (isMobile) {
        const mobileInput = document.getElementById('mobileMessageInput');
        const mobileForm = document.getElementById('mobileChatForm');
        if (mobileInput && mobileForm) {
            mobileInput.value = message;
            mobileForm.dispatchEvent(new Event('submit'));
        }
    } else {
        const desktopInput = document.getElementById('messageInput');
        const desktopForm = document.getElementById('chatForm');
        if (desktopInput && desktopForm) {
            desktopInput.value = message;
            desktopForm.dispatchEvent(new Event('submit'));
        }
    }
}

// Handle form submission
document.getElementById('chatForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const messageInput = document.getElementById('messageInput');
    const imageInput = document.getElementById('imageInput');
    const sendBtn = document.getElementById('sendBtn');
    const typingIndicator = document.getElementById('typingIndicator');

    const message = messageInput.value.trim();
    if (!message && !imageInput.files[0]) return;

    // Disable input and show loading
    messageInput.disabled = true;
    sendBtn.disabled = true;
    typingIndicator.style.display = 'flex';

    // Add user message to chat
    addMessageToChat('user', message, imageInput.files[0]);

    // Clear input
    messageInput.value = '';
    messageInput.style.height = 'auto';
    removeImage();

    // Scroll to bottom
    scrollToBottom();

    try {
        // Prepare form data
        const formData = new FormData();
        formData.append('message', message);
        formData.append('conversation_id', currentConversationId);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

        if (imageInput.files[0]) {
            formData.append('image', imageInput.files[0]);
        }

        // Send to API
        const response = await fetch('{% url "ai_assistant:send_message" %}', {
            method: 'POST',
            body: formData
        });

        // Check if response is ok
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
            // Update conversation ID
            currentConversationId = data.conversation_id;

            // Add AI response to chat
            addMessageToChat('assistant', data.ai_message.content);

            // Update URL if new conversation
            if (!{% if conversation %}true{% else %}false{% endif %}) {
                history.pushState({}, '', `/ai/chat/${currentConversationId}/`);
            }

            // Show task suggestions if any
            if (data.suggestions && data.suggestions.length > 0) {
                showTaskSuggestions(data.suggestions);
            }

        } else {
            // Show error
            addMessageToChat('system', `خطأ: ${data.error || 'حدث خطأ غير معروف'}`);
        }

    } catch (error) {
        console.error('Error:', error);
        addMessageToChat('system', 'حدث خطأ في الاتصال. يرجى المحاولة مرة أخرى.');
    } finally {
        // Re-enable input
        messageInput.disabled = false;
        sendBtn.disabled = false;
        typingIndicator.style.display = 'none';
        messageInput.focus();
        scrollToBottom();
    }
});

// تحويل Markdown إلى HTML
function parseMarkdown(text) {
    try {
        // استخدام مكتبة Marked إذا كانت متوفرة
        if (typeof marked !== 'undefined') {
            // إعداد خيارات Marked
            marked.setOptions({
                breaks: true,
                gfm: true,
                sanitize: false,
                smartLists: true,
                smartypants: true
            });

            return marked.parse(text);
        }
    } catch (error) {
        console.warn('خطأ في معالجة Markdown:', error);
    }

    // معالجة Markdown يدوياً كـ fallback
    let html = text;

    // تحويل العناوين
    html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
    html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
    html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');

    // تحويل النص العريض
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    html = html.replace(/__(.*?)__/g, '<strong>$1</strong>');

    // تحويل النص المائل
    html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
    html = html.replace(/_(.*?)_/g, '<em>$1</em>');

    // تحويل الكود المضمن
    html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

    // تحويل كتل الكود
    html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');

    // تحويل القوائم غير المرتبة
    html = html.replace(/^[\*\-\+] (.+)$/gm, '<li>$1</li>');

    // تحويل القوائم المرقمة
    html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');

    // تجميع عناصر القائمة في ul
    html = html.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');

    // تحويل الاقتباسات
    html = html.replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>');

    // تحويل الروابط
    html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');

    // تحويل أسطر جديدة
    html = html.replace(/\n/g, '<br>');

    return html;
}

// نسخ النص
function copyToClipboard(text, button) {
    // إزالة HTML tags للنسخ
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = text;
    const plainText = tempDiv.textContent || tempDiv.innerText || '';

    navigator.clipboard.writeText(plainText).then(() => {
        // تغيير شكل الزر
        button.classList.add('copied');
        button.innerHTML = '<i class="fas fa-check"></i><span>تم النسخ</span>';

        // إعادة الزر لحالته الأصلية بعد 2 ثانية
        setTimeout(() => {
            button.classList.remove('copied');
            button.innerHTML = '<i class="fas fa-copy"></i><span>نسخ</span>';
        }, 2000);
    }).catch(err => {
        console.error('فشل في نسخ النص: ', err);
        // fallback للمتصفحات القديمة
        const textArea = document.createElement('textarea');
        textArea.value = plainText;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);

        button.classList.add('copied');
        button.innerHTML = '<i class="fas fa-check"></i><span>تم النسخ</span>';
        setTimeout(() => {
            button.classList.remove('copied');
            button.innerHTML = '<i class="fas fa-copy"></i><span>نسخ</span>';
        }, 2000);
    });
}

// Add message to chat
function addMessageToChat(type, content, imageFile = null) {
    const chatContainer = document.getElementById('chatContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    messageDiv.style.position = 'relative';

    const avatarDiv = document.createElement('div');
    avatarDiv.className = 'message-avatar';

    if (type === 'user') {
        avatarDiv.innerHTML = '<i class="fas fa-user"></i>';
    } else if (type === 'assistant') {
        avatarDiv.innerHTML = '<i class="fas fa-robot"></i>';
    } else {
        avatarDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
    }

    const bubbleDiv = document.createElement('div');
    bubbleDiv.className = 'message-bubble';

    // إضافة أيقونات وزر النسخ للرسائل من المساعد
    if (type === 'assistant') {
        const headerDiv = document.createElement('div');
        headerDiv.className = 'ai-message-header';

        // إضافة الأيقونات
        const iconsDiv = document.createElement('div');
        iconsDiv.className = 'ai-icons';

        const robotIcon = document.createElement('div');
        robotIcon.className = 'ai-icon';
        robotIcon.innerHTML = '<i class="fas fa-robot"></i>';

        const brainIcon = document.createElement('div');
        brainIcon.className = 'ai-icon';
        brainIcon.innerHTML = '<i class="fas fa-brain"></i>';

        const magicIcon = document.createElement('div');
        magicIcon.className = 'ai-icon';
        magicIcon.innerHTML = '<i class="fas fa-magic"></i>';

        iconsDiv.appendChild(robotIcon);
        iconsDiv.appendChild(brainIcon);
        iconsDiv.appendChild(magicIcon);

        // إضافة زر النسخ
        const copyButton = document.createElement('button');
        copyButton.className = 'copy-btn';
        copyButton.innerHTML = '<i class="fas fa-copy"></i><span>نسخ</span>';
        copyButton.onclick = () => copyToClipboard(content, copyButton);

        headerDiv.appendChild(iconsDiv);
        headerDiv.appendChild(copyButton);
        bubbleDiv.appendChild(headerDiv);

        // إضافة تفاعل للأيقونات في الكمبيوتر
        if (window.innerWidth >= 768) {
            // تأثير النقر على الأيقونات
            robotIcon.addEventListener('click', function() {
                this.style.animation = 'iconClick 0.3s ease-out';
                setTimeout(() => {
                    this.style.animation = 'float 3s ease-in-out infinite, iconAppear 0.6s ease-out';
                }, 300);
            });

            brainIcon.addEventListener('click', function() {
                this.style.animation = 'iconClick 0.3s ease-out';
                setTimeout(() => {
                    this.style.animation = 'float 3s ease-in-out infinite, iconAppear 0.6s ease-out';
                    this.style.animationDelay = '1s, 0.3s';
                }, 300);
            });

            magicIcon.addEventListener('click', function() {
                this.style.animation = 'iconClick 0.3s ease-out';
                setTimeout(() => {
                    this.style.animation = 'float 3s ease-in-out infinite, iconAppear 0.6s ease-out';
                    this.style.animationDelay = '2s, 0.5s';
                }, 300);
            });
        }
    }

    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';

    // تطبيق تنسيق Markdown للرسائل من المساعد
    if (type === 'assistant') {
        contentDiv.innerHTML = parseMarkdown(content);
    } else {
        contentDiv.innerHTML = content.replace(/\n/g, '<br>');
    }

    // Add image if provided
    if (imageFile) {
        const img = document.createElement('img');
        img.className = 'image-preview';
        img.src = URL.createObjectURL(imageFile);
        contentDiv.appendChild(img);
    }

    const timeDiv = document.createElement('div');
    timeDiv.className = 'message-time';
    timeDiv.textContent = new Date().toLocaleTimeString('ar-SA', {hour: '2-digit', minute: '2-digit'});

    bubbleDiv.appendChild(contentDiv);
    bubbleDiv.appendChild(timeDiv);
    messageDiv.appendChild(avatarDiv);
    messageDiv.appendChild(bubbleDiv);

    // Insert before typing indicator
    const typingIndicator = document.getElementById('typingIndicator');
    chatContainer.insertBefore(messageDiv, typingIndicator);
}

// Scroll to bottom
function scrollToBottom() {
    const chatContainer = document.getElementById('chatContainer');
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Load conversation
function loadConversation(conversationId) {
    // إغلاق قائمة المحادثات في الجوال
    closeMobileConversations();

    // الانتقال إلى المحادثة
    window.location.href = `/ai/chat/${conversationId}/`;
}

// Start new conversation
function startNewConversation() {
    // إغلاق قائمة المحادثات في الجوال
    closeMobileConversations();

    // بدء محادثة جديدة
    window.location.href = '{% url "ai_assistant:chat" %}';
}



// Show task suggestions
function showTaskSuggestions(suggestions) {
    // This would show a modal or notification with task suggestions
    // For now, just log them
    console.log('Task suggestions:', suggestions);
}

// Handle Enter key
document.getElementById('messageInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('chatForm').dispatchEvent(new Event('submit'));
    }
});

// Mobile functions
function removeMobileImage() {
    document.getElementById('mobileImageInput').value = '';
    document.getElementById('mobileImagePreview').style.display = 'none';
}

function showMobileImagePreview(file) {
    const preview = document.getElementById('mobileImagePreview');
    const img = document.getElementById('mobilePreviewImg');

    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            img.src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
}

function addMobileMessageToChat(type, content, imageFile = null) {
    const chatContainer = document.getElementById('mobileChatContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `mobile-message ${type}`;

    const avatarDiv = document.createElement('div');
    avatarDiv.className = 'mobile-message-avatar';

    if (type === 'user') {
        avatarDiv.innerHTML = '<i class="fas fa-user"></i>';
    } else if (type === 'assistant') {
        avatarDiv.innerHTML = '<i class="fas fa-robot"></i>';
    } else {
        avatarDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
    }

    const bubbleDiv = document.createElement('div');
    bubbleDiv.className = 'mobile-message-bubble';

    // إضافة أيقونات وزر النسخ للرسائل من المساعد في الجوال
    if (type === 'assistant') {
        const headerDiv = document.createElement('div');
        headerDiv.className = 'ai-message-header';

        // إضافة الأيقونات
        const iconsDiv = document.createElement('div');
        iconsDiv.className = 'ai-icons';

        const robotIcon = document.createElement('div');
        robotIcon.className = 'ai-icon';
        robotIcon.innerHTML = '<i class="fas fa-robot"></i>';

        const brainIcon = document.createElement('div');
        brainIcon.className = 'ai-icon';
        brainIcon.innerHTML = '<i class="fas fa-brain"></i>';

        const magicIcon = document.createElement('div');
        magicIcon.className = 'ai-icon';
        magicIcon.innerHTML = '<i class="fas fa-magic"></i>';

        iconsDiv.appendChild(robotIcon);
        iconsDiv.appendChild(brainIcon);
        iconsDiv.appendChild(magicIcon);

        // إضافة زر النسخ
        const copyButton = document.createElement('button');
        copyButton.className = 'copy-btn';
        copyButton.innerHTML = '<i class="fas fa-copy"></i><span>نسخ</span>';
        copyButton.onclick = () => copyToClipboard(content, copyButton);

        headerDiv.appendChild(iconsDiv);
        headerDiv.appendChild(copyButton);
        bubbleDiv.appendChild(headerDiv);

        // إضافة تفاعل للأيقونات في الجوال (مبسط)
        if (window.innerWidth < 768) {
            [robotIcon, brainIcon, magicIcon].forEach((icon) => {
                icon.addEventListener('click', function() {
                    this.style.transform = 'scale(1.1)';
                    setTimeout(() => {
                        this.style.transform = 'scale(1)';
                    }, 200);
                });
            });
        }
    }

    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';

    // تطبيق تنسيق Markdown للرسائل من المساعد
    if (type === 'assistant') {
        contentDiv.innerHTML = parseMarkdown(content);
    } else {
        contentDiv.innerHTML = content.replace(/\n/g, '<br>');
    }

    // Add image if provided
    if (imageFile) {
        const img = document.createElement('img');
        img.className = 'image-preview';
        img.src = URL.createObjectURL(imageFile);
        contentDiv.appendChild(img);
    }

    const timeDiv = document.createElement('div');
    timeDiv.className = 'mobile-message-time';
    timeDiv.textContent = new Date().toLocaleTimeString('ar-SA', {hour: '2-digit', minute: '2-digit'});

    bubbleDiv.appendChild(contentDiv);
    bubbleDiv.appendChild(timeDiv);
    messageDiv.appendChild(avatarDiv);
    messageDiv.appendChild(bubbleDiv);

    // Insert before typing indicator
    const typingIndicator = document.getElementById('mobileTypingIndicator');
    chatContainer.insertBefore(messageDiv, typingIndicator);
}

function scrollMobileToBottom() {
    const chatContainer = document.getElementById('mobileChatContainer');
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Mobile conversations functions
function toggleMobileConversations() {
    const overlay = document.getElementById('mobileConversationsOverlay');
    const sidebar = document.getElementById('mobileConversationsSidebar');

    if (overlay && sidebar) {
        const isVisible = overlay.classList.contains('show');

        if (isVisible) {
            closeMobileConversations();
        } else {
            openMobileConversations();
        }
    }
}

function openMobileConversations() {
    const overlay = document.getElementById('mobileConversationsOverlay');
    const sidebar = document.getElementById('mobileConversationsSidebar');

    if (overlay && sidebar) {
        overlay.classList.add('show');
        sidebar.classList.add('show');
        document.body.style.overflow = 'hidden';
    }
}

function closeMobileConversations() {
    const overlay = document.getElementById('mobileConversationsOverlay');
    const sidebar = document.getElementById('mobileConversationsSidebar');

    if (overlay && sidebar) {
        overlay.classList.remove('show');
        sidebar.classList.remove('show');
        document.body.style.overflow = '';
    }
}

// Auto-scroll to bottom on page load
document.addEventListener('DOMContentLoaded', function() {
    scrollToBottom();
    scrollMobileToBottom();

    // إغلاق قائمة المحادثات عند الضغط على Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeMobileConversations();
        }
    });

    // Mobile textarea auto-resize
    const mobileInput = document.getElementById('mobileMessageInput');
    if (mobileInput) {
        mobileInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // Mobile Enter key handler
        mobileInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('mobileChatForm').dispatchEvent(new Event('submit'));
            }
        });
    }

    // Mobile image input handler
    const mobileImageInput = document.getElementById('mobileImageInput');
    if (mobileImageInput) {
        mobileImageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // التحقق من نوع الملف
                if (!file.type.startsWith('image/')) {
                    alert('يرجى اختيار ملف صورة صالح');
                    return;
                }

                // التحقق من حجم الملف (5MB max)
                if (file.size > 5 * 1024 * 1024) {
                    alert('حجم الصورة كبير جداً. يرجى اختيار صورة أصغر من 5MB');
                    return;
                }

                showMobileImagePreview(file);
            }
        });
    }

    // Mobile form submission
    const mobileForm = document.getElementById('mobileChatForm');
    if (mobileForm) {
        mobileForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const messageInput = document.getElementById('mobileMessageInput');
            const imageInput = document.getElementById('mobileImageInput');
            const sendBtn = document.getElementById('mobileSendBtn');
            const typingIndicator = document.getElementById('mobileTypingIndicator');
            const loadingIndicator = document.getElementById('mobileLoadingIndicator');

            const message = messageInput.value.trim();
            if (!message && !imageInput.files[0]) return;

            // Disable input and show loading
            messageInput.disabled = true;
            sendBtn.disabled = true;
            typingIndicator.style.display = 'flex';
            loadingIndicator.classList.add('show');

            // Add user message to chat
            addMobileMessageToChat('user', message, imageInput.files[0]);

            // Clear input
            messageInput.value = '';
            messageInput.style.height = 'auto';
            removeMobileImage();

            // Scroll to bottom
            scrollMobileToBottom();

            try {
                // Prepare form data
                const formData = new FormData();
                formData.append('message', message);
                formData.append('conversation_id', currentConversationId);
                formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

                if (imageInput.files[0]) {
                    formData.append('image', imageInput.files[0]);
                }

                // Send to API
                const response = await fetch('{% url "ai_assistant:send_message" %}', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    // Update conversation ID
                    currentConversationId = data.conversation_id;

                    // Add AI response to chat
                    addMobileMessageToChat('assistant', data.ai_message.content);

                    // Update URL if new conversation
                    if (!{% if conversation %}true{% else %}false{% endif %}) {
                        history.pushState({}, '', `/ai/chat/${currentConversationId}/`);
                    }

                } else {
                    // Show error
                    addMobileMessageToChat('system', `خطأ: ${data.error || 'حدث خطأ غير معروف'}`);
                }

            } catch (error) {
                console.error('Error:', error);
                addMobileMessageToChat('system', 'حدث خطأ في الاتصال. يرجى المحاولة مرة أخرى.');
            } finally {
                // Re-enable input
                messageInput.disabled = false;
                sendBtn.disabled = false;
                typingIndicator.style.display = 'none';
                loadingIndicator.classList.remove('show');
                messageInput.focus();
                scrollMobileToBottom();
            }
        });
    }
});
</script>
{% endblock %}
